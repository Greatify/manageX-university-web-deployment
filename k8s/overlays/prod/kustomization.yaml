# Kustomization configuration for production environment
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: managex-university-production
namePrefix: managex-
nameSuffix: -production
labels:
  - pairs:
      environment: production
    includeSelectors: false
    includeTemplates: true
resources:
  - ../../base

# Patches for different Kubernetes resources
patches:
  # Patch for CronJob configuration
  - target:
      kind: CronJob
      name: university-cronjob
    patch: |-
      apiVersion: batch/v1
      kind: CronJob
      metadata:
        name: university-cronjob
        labels:
          app: university-cronjob
      spec:
        jobTemplate:
          spec:
            template:
              metadata:
                labels:
                  app: university-cronjob
              spec:
                volumes:
                  - name: university-secrets
                    csi:
                      driver: secrets-store.csi.k8s.io
                      readOnly: true
                      volumeAttributes:
                        secretProviderClass: managex-university-secrets-production

  # Patch for Deployment configuration
  - target:
      kind: Deployment
      name: university
    patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: university
      spec:
        template:
          spec:
            volumes:
              - name: university-secrets
                csi:
                  driver: secrets-store.csi.k8s.io
                  readOnly: true
                  volumeAttributes:
                    secretProviderClass: managex-university-secrets-production
              - name: university-server-configuration
                configMap:
                  name: managex-university-server-config-production
              - name: university-nginx-configuration
                configMap:
                  name: managex-university-nginx-config-production
            containers:
              - name: managex-university
                resources:
                  requests:
                    cpu: "1"
                    memory: 4Gi
                  limits:
                    cpu: "2"
                    memory: 8Gi
                livenessProbe:
                  httpGet:
                    path: /
                    port: 80
                  initialDelaySeconds: 30
                  periodSeconds: 15
                  timeoutSeconds: 2
                  failureThreshold: 3
                readinessProbe:
                  httpGet:
                    path: /
                    port: 80
                  initialDelaySeconds: 30
                  periodSeconds: 10
                  timeoutSeconds: 2
                  failureThreshold: 3
                    

  # Patch for Ingress configuration
  - target:
      kind: Ingress
      name: university-ingress
    patch: |-
      apiVersion: networking.k8s.io/v1
      kind: Ingress
      metadata:
        name: university-ingress
        annotations:
          alb.ingress.kubernetes.io/certificate-arn: arn:aws:acm:ap-south-1:399600302704:certificate/e1e53fd8-f0f1-4444-b19c-dca37a1a7f57
      spec:
        rules:
          - http:
              paths:
                - path: /
                  pathType: Prefix
                  backend:
                    service:
                      name: managex-university-service-production
                      port:
                        number: 80
        tls:
          - hosts:
              - greatify.xyz
            secretName: tls-secret

  # Patch for HorizontalPodAutoscaler configuration
  - target:
      kind: HorizontalPodAutoscaler
      name: university-pod-autoscaler
    patch: |-
      apiVersion: autoscaling/v2
      kind: HorizontalPodAutoscaler
      metadata:
        name: university-pod-autoscaler
      spec:
        scaleTargetRef:
          name: managex-university-production
        behavior:
          scaleDown:
            stabilizationWindowSeconds: 60

  # Patch for SecretProviderClass configuration
  - target:
      kind: SecretProviderClass
      name: university-secrets
    patch: |-
      apiVersion: secrets-store.csi.x-k8s.io/v1
      kind: SecretProviderClass
      metadata:
        name: university-secrets
      spec:
        parameters:
          objects: |
            - objectName: arn:aws:secretsmanager:ap-south-1:399600302704:secret:Managex-University-Production-c2veuS
              objectAlias: ".env"
              objectType: "secretsmanager"

  # Patch for Nginx ConfigMap configuration
  - target:
      kind: ConfigMap
      name: university-nginx-config
    patch: |-
      apiVersion: v1
      kind: ConfigMap
      metadata:
        name: university-nginx-config
      data:
        nginx.conf: |
          user www-data;
          worker_processes auto;
          pid /run/nginx.pid;
          include /etc/nginx/modules-enabled/*.conf;

          events {
              worker_connections 1024;
              multi_accept on;
              use epoll;
          }

          http {
              ##
              # Basic Settings
              ##
              sendfile on;
              tcp_nopush on;
              tcp_nodelay on;
              keepalive_timeout 65;
              types_hash_max_size 2048;
              server_tokens off;
              
              # Global timeout settings
              proxy_read_timeout 600;
              proxy_connect_timeout 600;
              proxy_send_timeout 600;
              fastcgi_read_timeout 600;
              fastcgi_connect_timeout 600;
              fastcgi_send_timeout 600;

              # Global buffer sizes
              client_body_buffer_size 128k;
              client_header_buffer_size 3k;
              large_client_header_buffers 4 8k;
              client_max_body_size 1024M;

              # Global timeouts
              client_body_timeout 12;
              client_header_timeout 12;
              send_timeout 10;

              # Log format
              log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                                '$status $body_bytes_sent "$http_referer" '
                                '"$http_user_agent" "$http_x_forwarded_for"';

              # MIME
              include /etc/nginx/mime.types;
              default_type application/octet-stream;

              ##
              # SSL Settings
              ##
              ssl_protocols TLSv1.2 TLSv1.3;
              ssl_prefer_server_ciphers on;
              ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;

              ##
              # Logging Settings
              ##
              access_log /var/log/nginx/access.log main;
              error_log /var/log/nginx/error.log;

              ##
              # Gzip Settings
              ##
              gzip on;
              gzip_vary on;
              gzip_proxied any;
              gzip_comp_level 6;
              gzip_buffers 16 8k;
              gzip_http_version 1.1;
              gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

              ##
              # Global error page configuration
              ##
              fastcgi_intercept_errors off;
              proxy_intercept_errors off;
              ##
              # Virtual Host Configs
              ##
              include /etc/nginx/conf.d/*.conf;
              include /etc/nginx/sites-enabled/*;
          }